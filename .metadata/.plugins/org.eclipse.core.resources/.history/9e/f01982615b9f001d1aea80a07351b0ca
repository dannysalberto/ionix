package com.colsubsidio.purchaseorders.exceptions;

import java.sql.SQLIntegrityConstraintViolationException;
import java.util.List;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.validation.FieldError;
import org.springframework.web.bind.MethodArgumentNotValidException;
import org.springframework.web.bind.annotation.ControllerAdvice;
import org.springframework.web.bind.annotation.ExceptionHandler;

import com.colsubsidio.purchaseorders.response.GeneralResponse;
import com.colsubsidio.purchaseorders.utils.LogsManager;


@ControllerAdvice	
public class ExceptionGlobal {	
	
	String sListError="";
	
	@Autowired
	LogsManager logs;
	
	
	@ExceptionHandler(Exception.class)
    public ResponseEntity<GeneralResponse<?>> handleException(Exception ex) {
		logs.error("app-med-purchaseorder-api ->ExceptionGlobal, sqlException {} cause {} ", ex.getMessage());
	        return new ResponseEntity<GeneralResponse<?>>(GeneralResponse.builder()
					.code("500")
					.message(ex.getMessage()).success(false).build(), 
					HttpStatus.INTERNAL_SERVER_ERROR);		
    }

	
    @ExceptionHandler(MethodArgumentNotValidException.class)
    public ResponseEntity<GeneralResponse<?>> handleValidationErrors(MethodArgumentNotValidException ex) {
	        List<FieldError> fieldErrors = ex.getBindingResult().getFieldErrors();

	        fieldErrors.forEach(errorField->{
	        	sListError = sListError.concat(errorField.getDefaultMessage()).concat(", ");
	        });
	        logs.info("app-med-purchaseorder-api ->ExceptionGlobal, handleValidationErrors {} ", sListError);
	        return new ResponseEntity<GeneralResponse<?>>(GeneralResponse.builder()
					.code("400")
					.message(sListError).success(false).build(), 
					HttpStatus.BAD_REQUEST);		
    }
    
    @ExceptionHandler(SupplierNotFoundException.class)
    public ResponseEntity<GeneralResponse<?>> supplierNotFoundException(SupplierNotFoundException ex) {
    	logs.error("app-med-purchaseorder-api  ->ExceptionGlobal,  supplierNotFoundException {} ", ex);
	    return new ResponseEntity<GeneralResponse<?>>(GeneralResponse.builder()
					.code("404")
					.message(ex.getLocalizedMessage()).success(false).build(), 
					HttpStatus.NOT_FOUND);		
    }
    
    @ExceptionHandler(StateNotFoundException.class)
    public ResponseEntity<GeneralResponse<?>> stateNotFoundException(StateNotFoundException ex) {
    	logs.error("app-med-purchaseorder-api ->ExceptionGlobal, stateNotFoundException {} ", ex);
	    return new ResponseEntity<GeneralResponse<?>>(GeneralResponse.builder()
					.code("404")
					.message(ex.getLocalizedMessage()).success(false).build(), 
					HttpStatus.NOT_FOUND);		
    }
    
    @ExceptionHandler(BadRequestException.class)
    public ResponseEntity<GeneralResponse<?>> badRequestException(BadRequestException ex) {
    	logs.error("app-med-purchaseorder-api ->ExceptionGlobal,  badRequestException {} ", ex);
	    return new ResponseEntity<GeneralResponse<?>>(GeneralResponse.builder()
					.code("400")
					.message(ex.getLocalizedMessage()).success(false).build(), 
					HttpStatus.BAD_REQUEST);		
    }
    
    @ExceptionHandler(OrderNotFoundException.class)
    public ResponseEntity<GeneralResponse<?>> orderNotFoundException(OrderNotFoundException ex) {
		logs.error("app-med-purchaseorder-api ->ExceptionGlobal, orderNotFoundException {} ", ex);
	    return new ResponseEntity<GeneralResponse<?>>(GeneralResponse.builder()
					.code("404")
					.message(ex.getLocalizedMessage()).success(false).build(), 
					HttpStatus.NOT_FOUND);		
    }
    
    @ExceptionHandler(SQLIntegrityConstraintViolationException.class)
    public ResponseEntity<GeneralResponse<?>> sqlIntegrityConstraintViolationException(SQLIntegrityConstraintViolationException ex) {
		logs.error("app-med-purchaseorder-api ->ExceptionGlobal, SQLIntegrityConstraintViolationException {} ", ex);
	    return new ResponseEntity<GeneralResponse<?>>(GeneralResponse.builder()
					.code("404")
					.message(ex.getLocalizedMessage()).success(false).build(), 
					HttpStatus.NOT_FOUND);		
    }

    
}